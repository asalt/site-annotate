---
title: "1141-modi"
author: "MSPC"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    highlight: zenburn
    toc: yes
    toc_float: false
    self_contained: true
params:
  data_dir: NULL
  metadata: NULL
  modi_abbrev: ac 
---

<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r setup, include=T}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(rlang))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(magrittr))
suppressPackageStartupMessages(library(purrr))
suppressPackageStartupMessages(library(ComplexHeatmap))
suppressPackageStartupMessages(library(circlize))
suppressPackageStartupMessages(library(reactable))
suppressPackageStartupMessages(library(RColorBrewer))
library(dendsort)


library(knitr)
myreactable <- function(x, ...) reactable(x, defaultPageSize = 14, searchable = T, compact = T, resizable=T, sortable = T, filterable = T, ...)



OUTDIR <- params$outdir %||% params$data_dir %||% "."

```

```{r, label=funcs, include=F}


create_named_color_list <- function(df, columns) {
  # Matplotlib default colors (from memory)
  matplotlib_colors <- c("#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", 
                         "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", 
                         "#bcbd22", "#17becf")
  
  # Initialize an empty list to store the result
  color_list <- list()
  
  # Iterate over each column
  for (col_name in columns) {
    unique_vals <- unique(df[[col_name]])
    n_vals <- length(unique_vals)
    
    # Assign colors based on the number of unique values, recycling matplotlib colors if needed
    colors_assigned <- rep(matplotlib_colors, length.out = n_vals)
    
    # Create a named vector for the unique values with corresponding colors
    color_list[[col_name]] <- setNames(colors_assigned, unique_vals)
  }
  
  return(color_list)
}


myzscore <- function(value, minval = NA, remask = TRUE) {
  mask <- is.na(value)
  if (is.na(minval)) minval <- min(value, na.rm = TRUE)

  if (minval == Inf) {
    minval <- 0
  }

  value[is.na(value)] <- minval
  # todo make smaller than min val
  out <- scale(value)

  # if all NA:
  if (sum(!is.finite(out)) == length(out)) {
    out[, 1] <- 0
  }

  if (remask == TRUE) {
    out[mask] <- NA
  }
  return(out)
}

dist_no_na <- function(mat) {
  mat[is.na(mat)] <- min(mat, na.rm = TRUE)
  edist <- dist(mat)
  return(edist)
}


read_expr <- function(.x){
  df <- readr::read_tsv(.x, 
                       # n_max=400,
                        show_col_types = FALSE
                        ) %>%
    mutate(expr_file = .x)
  # mutate(modi_id = basename(id) %>% str_extract(pattern = "(sty|k)_[0-9]+_[0-9]+")) %>%

  df %<>% mutate(sitename = if_else(is.na(sitename2), sitename, sitename2))
  if ("geneid" %in% colnames(df)) df %<>% mutate(geneid = as.character(geneid)) 

  if ("cst_cat#" %in% colnames(df)) df %<>% mutate(`cst_cat#` = as.character(`cst_cat#`))

  if ("all_possible_positions" %in% colnames(df)) df$all_possible_positions <- NULL
  if ("all_possible_positions_psp" %in% colnames(df)) df$all_possible_positions_psp <- NULL

  if ("ms_lit" %in% colnames(df)) df %<>% mutate(`ms_lit` = replace_na(ms_lit, 0))
  if ("lt_lit" %in% colnames(df)) df %<>% mutate(`lt_lit` = replace_na(lt_lit, 0))

  if (!"fifteenmer" %in% colnames(df)) stop('fifteenmer missing')
  if (!"ENSP" %in% colnames(df)) stop('ENSP missing, this is a protein id ')
  if (!"sitename" %in% colnames(df)) stop('sitename missing')
  if (!"taxon" %in% colnames(df)) df$taxon <- "<NULL>"
  df %<>% mutate(site_id = str_c(sitename, ENSP, fifteenmer, sep='_'))

  return(df)
}

```


# load


params: 
```{r, label=load_meta}
(params)

if (!is.null(params$metadata)){
    meta <- read_tsv(params$metadata, show_col_types = FALSE)
    if (!"group" %in% colnames(meta)) meta$group <- meta$name
} else {
  cat("no metadata passed, exiting")
  knitr::knit_exit()
}

```

```{r, label = view_meta}
meta %>% myreactable
```


```{r, label=load_expr}

if (!"expr_file" %in% colnames(meta)){
  cat("not implemented yet, exiting")
  knitr::knit_exit()
}


expr_files <- meta$expr_file %>% unique 

datas <- expr_files %>%
    purrr::map( read_expr )  %>% 
    purrr::set_names(expr_files)

( names(datas) )

```


```{r}

data <- bind_rows(datas) # %>% dplyr::filter(!str_detect(protein, "\\|Cont_"))

# data %<>% distinct(sitename, ENSP, parent, fifteenmer, .keep_all = T)
# data %<>% distinct(sitename, parent, fifteenmer, hyperscore_best, .keep_all = T)

dplyr::glimpse(data)

# data %>% head() %>% myreactable()

```


# explore

```{r}
data %>%
  group_by(expr_file) %>%
  summarize(n = n()) %>%
  arrange(-n)
```

```{r}
datal <- data %>%
  pivot_longer(
    cols = starts_with("TMT"), names_to = "expr_col"
  ) %>%
  left_join(meta)

# datal %<>% dplyr::filter(!is.na(name))
datal %>% dplyr::glimpse()
```

# normalize

```{r}
.minval <- datal %>%
  dplyr::filter(value > 0) %>%
  pull(value) %>%
  min()
datal %<>%
  group_by(name, recno, runno, searchno, label, taxon) %>%
  mutate(
    val_mednorm = (value + (.minval / 2)) / median(value, na.rm = T)
  ) %>%
  ungroup() %>%
  mutate(
    log2_val = log2(val_mednorm)
  )  %>%
  group_by(site_id) %>% mutate(zscore = myzscore(log2_val)) %>% ungroup()

counts <- datal %>% 
  dplyr::filter(!is.na(log2_val)) %>% 
  group_by(site_id) %>% 
  summarize(n=n()) %>%
  arrange(-n)
maxn <- min(max(counts$n), nrow(metadata))
tokeep <- counts %>% filter(n == maxn)
datal %<>% dplyr::filter(
  site_id %in% tokeep$site_id
)

  # (counts)
  # (maxn)
# datal %>% head() %>% myreactable()
```


```{r, eval=F}

do_combat <- function(datal){
  data_wide <- datal %>%
    pivot_wider(id_cols = site_id, names_from = name, values_from = log2_val)
  mat <- data_wide[, meta$name] %>% as.matrix
  rownames(mat) <-  data_wide$site_id
  corrected_data <- sva::ComBat(dat = mat, batch = meta$recno %>% as.character )
}
combat_corrected <- do_combat(datal) 
combat_corrected %<>% as.data.frame %>% rownames_to_column(var="site_id")
combat_correctedl <- combat_corrected %>% pivot_longer(-site_id, values_to = 'log2_val_combat')
datal2 <- datal %>% left_join(combat_correctedl)
datal <- datal2

#
datal %<>%
  group_by(site_id) %>%
  mutate(
    zscore = myzscore(log2_val_combat)
  ) %>%
  filter(!all(is.na(value))) %>% # this will get rid of all nas
  ungroup()

# datal %>% filter(fifteenmer == "AFLCGVMkTYRQREK", ENSG == "ENSMUSG00000066037", geneid == "74326", symbol == "Hnrnpr", taxon == 10090)
```

```{r}
( datal %>%   nrow() )
( datal %>%  distinct(spectra, .keep_all=T) %>% nrow() )
( datal %>%  distinct(name, spectra, .keep_all=T) %>% nrow() )
```

```{r}
datal %>%
  distinct(name, spectra, .keep_all=T) %>%
  ggplot(aes(x = log2_val, col = name)) +
  geom_density() +
  facet_wrap(~group)
```


```{r}
datal %>%
  distinct(name, spectra, .keep_all=T) %>%
  ggplot(aes(x = log2_val, col = name)) +
  geom_density() +
  facet_wrap(~expr_file)
```



```{r}
datal %>%
  distinct(name, spectra, .keep_all=T) %>%
  ggplot(aes(x = log2_val, col = name)) +
  geom_density() +
  facet_wrap(~expr_file+AA)
```




```{r}
# .id_cols <- c("fifteenmer", "ENSG", "ENSP", "geneid", "taxon", "position", "sitename", "id", "modi_id")
#datal %>% dplyr::summarise(n = dplyr::n(), .by = c(fifteenmer, ENSG, ENSP, geneid, taxon, sitename, id, name))
dataw <- datal %>%
  pivot_wider(
    id_cols = site_id,
    names_from = name,
    #values_fn = function(x) median(x, na.rm = T),
    values_from = log2_val, # sometimes this happens after merging with phosphositeplus table
  )
```
# limma
```{r, label='limma'}
library(limma)

mod <- model.matrix(~ 0 + group, meta)
rownames(mod) <- meta$name
mat <- dataw[, meta$name]
colnames(mod) <- make.names(colnames(mod))

generate_contrasts <- function(df, group_var) {
  # Get unique levels of the grouping variable
  group_levels <- unique(df[[group_var]])
  
  # Generate all pairwise combinations of group levels
  contrast_combinations <- combn(group_levels, 2, simplify = FALSE)
  
  # Create contrasts for each combination
  contrast_strings <- lapply(contrast_combinations, function(combo) {
    paste(paste0(group_var, combo[1]), "-", paste0(group_var, combo[2]))
  }) %>% unlist()
  return(contrast_strings)
}


contrast_strings <- generate_contrasts(meta, "group") 
contrasts <- makeContrasts(contrasts = contrast_strings, levels = mod)

 # ( contrasts <- limma::makeContrasts(contrast_strings, levels = mod) )
```






```{r, label='lmFit'}
fit <- limma::lmFit(mat, mod)
fit <- contrasts.fit(fit, contrasts)
fitres <- fit %>% limma::eBayes(robust = T, trend = T)
```



```{r}
toptables <- colnames(contrasts) %>%
  purrr::map(~ {
    limma::topTable(fitres, coef = .x, number = Inf, sort.by = "none")
  }) %>%
  setNames(nm = colnames(contrasts))


toptables2 <- toptables %>% purrr::map(~ {
  assertthat::are_equal(nrow(.x), nrow(dataw))
  bind_cols(
    dataw %>% select(-meta$name),
    .x
  ) %>% arrange(P.Value) %>% 
    left_join(data %>% select(
      acc_id,
      lt_lit,
      ms_lit,
      fifteenmer,
      sitename,
      uniprot_id,
      ENSP,
      site_id
    ) %>% 
    distinct()
  )
  
})


toptables2 %>% purrr::iwalk(~ {
  .outdir <- file.path(OUTDIR, "results", "modi")
  if (!fs::dir_exists(.outdir)) fs::dir_create(.outdir)
  .outf <- .y %>% str_replace(" - ", "_minus_")
  .fulloutf <- file.path(.outdir, paste0(make.names(.outf), ".tsv"))
  cat(paste0("Writing ", .fulloutf,'\n'))
  .x %>% write_tsv(.fulloutf)
})
```



## stat overview

```{r}
plts <- toptables2 %>%
  purrr::imap(
    ~ {
      plt <- .x %>%
        ggplot(aes(x = P.Value)) +
        geom_histogram(binwidth = .05, ) +
        labs(title = paste0(.y, "\n", "p value dist"))
      print(plt)
    }
  )
```


```{r}
plts <- toptables2 %>%
  purrr::imap(
    ~ {
      plt <- .x %>%
        ggplot(aes(x = adj.P.Val)) +
        geom_histogram(binwidth = .05) +
        labs(title = paste0(.y, "\n", "adj p value dist"))
      print(plt)
    }
  )
```

```{r, include=F}
# to initialize the js dependency
reactable(mtcars)
```


```{r, results='asis', eval=T}
._ <- toptables2 %>%
  purrr::imap(~ {
    print(paste0("## ", .y))
    .x %>%
      arrange(P.Value) %>%
      select( -AveExpr, -B) %>%
      select(sitename, everything()) %>%
      head(40) %>%
      myreactable(
        showSortable = T,
        wrap = F,
        bordered = TRUE,
        columns = list(
          sitename = colDef(sticky = "left", style = list(backgroundColor = "#8af")),
          `P.Value` = colDef(format = colFormat(digits = 4)),
          `adj.P.Val` = colDef(format = colFormat(digits = 4)),
          `logFC` = colDef(format = colFormat(digits = 4)),
          `t` = colDef(format = colFormat(digits = 4))
        )
      ) %>%
      htmltools::tagList() %>%
      print()
  })
```



```{r, label = exit_early, eval=F}
save.image(file.path(params$data_dir, 'env.RData'))
knitr::knit_exit()
```


```{r}
suppressPackageStartupMessages(library(ComplexHeatmap))
suppressPackageStartupMessages(library(circlize))
```

```{r, fig.width=9, fig.height=12}
condense_groups <- function(.mat){
  
   # Identify numeric and non-numeric columns
  numeric_cols <- sapply(.mat, is.numeric) & !names(.mat) %in% c("ms_lit", "lt_lit")
  non_numeric_cols <- !numeric_cols
  # Group by all numeric columns and summarize non-numeric columns
  .mat2 <- .mat %>%  select(non_numeric_cols[ non_numeric_cols == TRUE] %>% names, numeric_cols[ numeric_cols == TRUE] %>% names )
  
  numeric_cols <- sapply(.mat2, is.numeric) & !names(.mat2) %in% c("ms_lit", "lt_lit")
  non_numeric_cols <- !numeric_cols
  
  condensed_data <- .mat2 %>%
    group_by(across(which(numeric_cols))) %>% 
    summarize(across(which(non_numeric_cols), ~paste(unique(.), collapse=", ")), .groups = 'drop')
  #%>%
 
  return(condensed_data)
}

do_plot <- function(.x, .y){
   n <- 60
  .sel <- .x %>%
    arrange(P.Value) %>%
    head(n = as.integer(100*n)) # hack

  .data <- datal %>%
    dplyr::filter(site_id %in% .sel$site_id) %>%
    dplyr::filter(!str_detect(name, "Refmix")) # %>%
  
  
  # mutate(position_absolut = as.character(position_absolut))
  # .id_cols <- c(
  #   "fifteenmer", "ENSG", "ENSP", "geneid", "symbol", "taxon", "AA", "position_absolut", "sitename", "id", "lt_lit",
  #   "ms_lit", "site_id"
  # )
  
  .mat <- .data %>% pivot_wider(id_cols = site_id, names_from = name, values_from = zscore, )
  .mat %<>% left_join(datal %>% distinct(site_id, ms_lit, lt_lit, sitename))
  .mat %<>% mutate(ms_lit = replace_na(ms_lit, 0), lt_lit = replace_na(lt_lit, 0))
  .mat <- condense_groups(.mat) %>% head(n = n) # condensing should maybe happen earlier
  
  # .mat <- .data %>% pivot_wider(id_cols = .id_cols, names_from = name, values_from = zscore, )
  .cids <- intersect(colnames(.mat), meta$name)
  .meta <- meta %>% dplyr::filter(name %in% .cids)


  .colors <- create_named_color_list(.meta, c('group'))
  ca <- ComplexHeatmap::columnAnnotation(
    # treat = .meta$treat,
    group = .meta$group,
    annotation_name_side = "left",
    col = .colors
  )

  #
  hide_zero <- function(x) {
    sapply(x, function(y) ifelse(y == 0, "", as.character(y)))
  }

  row_annotations <- HeatmapAnnotation(
    lt_lit = .mat$lt_lit %>% hide_zero() %>% anno_text(show_name = T, gp = gpar(fontsize = 7), location = unit(.5, "npc"), just = "centre"),
    ms_lit = .mat$ms_lit %>% hide_zero() %>% anno_text(show_name = T, gp = gpar(fontsize = 7), location = unit(.5, "npc"), just = "center"),
    which = "row",
    gp = gpar(fontsize = 2, size = 2),
    width = unit(1, "cm"),
    annotation_name_side = "top",
    border = T,
    show_annotation_name = T
  )

  .ht_mat <- .mat[, .meta$name] %>% as.matrix()
  ht <- ComplexHeatmap::Heatmap(
    .ht_mat,
    width = unit(ncol(.ht_mat) * .2, 'in'),
    height = unit(nrow(.ht_mat) * .24, 'in'),
    column_split = .meta$group,
    row_labels = .mat$sitename %>% stringr::str_wrap(width = 48),
    row_names_gp = grid::gpar(fontsize = 6),
    column_names_side = "top",
    heatmap_legend_param = list(title = "zscore"),
    column_title = .y,
    right_annotation = row_annotations,
    top_annotation = ca,
    cluster_rows = dendsort(hclust(dist(.ht_mat), method = "ward.D2")),
    # cluster_columns = dendsort(hclust(dist(t(.ht_mat)), method="ward.D2"))
    clustering_method_columns = "ward.D2"
    # clustering_method_rows = "ward.D2",
    # clustering_method_columns = "ward.D2"
  )

  .outdir <- file.path(OUTDIR, "results", "modi")
  .outf <- .y %>% str_replace(" - ", "_minus_")
  .fulloutf <- file.path(.outdir, paste0(make.names(.outf), "_top", as.character(n), ".pdf"))
  draw(ht)

  .height <- 7 + (nrow(.ht_mat) * .2 )
  .width <- 8 + (ncol(.ht_mat) * .2 )

  pdf(.fulloutf, height = .height, width = .width)
  print(ht)
  dev.off()


  # same thing but only the two comparison
  .comp <- .y %>%
    str_extract_all("(?<=group)[a-zA-Z0-9]+") %>%
    unlist()
  .data2 <- .data %>% dplyr::filter(group %in% .comp)
  .id_cols <- c("fifteenmer", "ENSG", "ENSP", "geneid", "symbol", "taxon", "AA", "position_absolut", "sitename", "id")
  .mat2 <- .data2 %>%
    #group_by(!!!rlang::syms(.id_cols)) %>%
    group_by(site_id) %>%
    mutate(zscore = myzscore(log2_val)) %>%
    ungroup() %>%
    # pivot_wider(id_cols = .id_cols, names_from = name, values_from = zscore, )
    pivot_wider(id_cols = site_id, names_from = name, values_from = zscore, )
  .mat2 %<>% left_join(datal %>% distinct(site_id, ms_lit, lt_lit, sitename))
  .mat2 %<>% mutate(ms_lit = replace_na(ms_lit, 0), lt_lit = replace_na(lt_lit, 0))
  .mat2 <- .mat2 %>% condense_groups() %>% head(n = n)
  .cids <- intersect(colnames(.mat2), meta$name)
  .meta <- meta %>% dplyr::filter(name %in% .cids)
  
  
  .ht_mat2 <- .mat2[, .meta$name] %>% as.matrix()
  .meta2 <- .meta %>%
    dplyr::filter(name %in% colnames(.mat2)) %>%
    mutate(name = factor(name, levels = colnames(.mat2), ordered = T)) %>%
    arrange(name)

  
  ca <- ComplexHeatmap::columnAnnotation(
    # treat = .meta2$treat,
    group = .meta2$group,
    annotation_name_side = "left",
    col = .colors
  )

  row_annotations <- HeatmapAnnotation(
    lt_lit = .mat2$lt_lit %>% hide_zero() %>% anno_text(show_name = T, gp = gpar(fontsize = 7), location = unit(.5, "npc"), just = "centre"),
    ms_lit = .mat2$ms_lit %>% hide_zero() %>% anno_text(show_name = T, gp = gpar(fontsize = 7), location = unit(.5, "npc"), just = "center"),
    gp = gpar(fontsize = 2, size = 2),
    width = unit(.32, "in"),
    annotation_name_side = "top",
    border = T,
    show_annotation_name = T,
    which = "row"
  )

  ht <- ComplexHeatmap::Heatmap(
    .ht_mat2,
    column_split = .meta2$group,
    width = unit(ncol(.ht_mat) * .2, 'in'),
    height = unit(nrow(.ht_mat) * .24, 'in'),
    row_labels = .mat2$sitename %>% stringr::str_wrap(width = 38),
    row_names_gp = grid::gpar(fontsize = 6),
    column_names_side = "top",
    heatmap_legend_param = list(title = "zscore"),
    column_title = .y,
    top_annotation = ca,
    right_annotation = row_annotations,
    cluster_rows = dendsort(hclust(dist(.ht_mat2), method = "ward.D2")),
    # cluster_columns = dendsort(hclust(dist(t(.ht_mat2)), method="ward.D2"))
    clustering_method_columns = "ward.D2"
  )

  .outdir <- file.path(OUTDIR, "results", "modi")
  .outf <- .y %>% str_replace(" - ", "_minus_")
  .fulloutf <- file.path(.outdir, paste0(make.names(.outf), "_top", as.character(n), "_subsel", ".pdf"))
  draw(ht)

  .height <- 7 + (nrow(.ht_mat2) * .2 )
  .width <- 8 + (ncol(.ht_mat2) * .2 )
  pdf(.fulloutf, height = .height, width = .width)
  print(ht)
  dev.off()
  
}

toptables2 %>% purrr::imap(~ do_plot(.x, .y) )


```{r, eval=F}
# histones <- list(
#   "HIST1H1A" = "3004",
#   "HIST1H1B" = "3005",
#   "HIST1H1C" = "3006",
#   "HIST1H1D" = "3007",
#   "HIST1H1E" = "3008",
#   "HIST1H2AA" = "8334",
#   "HIST1H2AB" = "8335",
#   "HIST1H2AC" = "8336",
#   "HIST1H2AD" = "8337",
#   "HIST1H2AE" = "8338",
#   "HIST1H2BA" = "3012",
#   "HIST1H2BB" = "3020",
#   "HIST1H2BC" = "8348",
#   "HIST1H2BD" = "8349",
#   "HIST1H2BE" = "8350",
#   "HIST1H3A" = "8351",
#   "HIST1H3B" = "8352",
#   "HIST1H3C" = "8353",
#   "HIST1H3D" = "8354",
#   "HIST1H3E" = "8355",
#   "HIST1H4A" = "8358",
#   "HIST1H4B" = "8360",
#   "HIST1H4C" = "8361",
#   "HIST1H4D" = "8362",
#   "HIST1H4E" = "8363",
#   "Hist1h1a" = "15089",
#   "Hist1h1b" = "15090",
#   "Hist1h1c" = "15091",
#   "Hist1h1d" = "15092",
#   "Hist1h1e" = "15093",
#   "Hist1h2aa" = "319165",
#   "Hist1h2ab" = "15094",
#   "Hist1h2ac" = "15095",
#   "Hist1h2ad" = "15096",
#   "Hist1h2ae" = "15097",
#   "Hist1h2ba" = "15107",
#   "Hist1h2bb" = "15108",
#   "Hist1h2bc" = "15109",
#   "Hist1h2bd" = "15110",
#   "Hist1h2be" = "15111",
#   "Hist1h3a" = "319160",
#   "Hist1h3b" = "319161",
#   "Hist1h3c" = "319162",
#   "Hist1h3d" = "319163",
#   "Hist1h3e" = "319164",
#   "Hist1h4a" = "15119",
#   "Hist1h4b" = "15120",
#   "Hist1h4c" = "15121",
#   "Hist1h4d" = "15122",
#   "Hist1h4e" = "15123"
# )

# .sel <- datal %>% distinct(geneid, .keep_all = T) %>% filter(geneid%in%histones)
.sel <- datal %>% filter(str_detect(symbol, "STAT1"))
# .sel <- datal %>% filter(str_detect(symbol, "Stat" )) there's no mouse stat1 present
.data <- datal %>%
  dplyr::filter(sitename %in% .sel$sitename) %>%
  dplyr::filter(!str_detect(name, "RefMix")) # %>%
# mutate(position_absolut = as.character(position_absolut))
.id_cols <- c(
  "fifteenmer", "ENSG", "ENSP", "geneid", "symbol", "taxon", "AA", "position_absolut", "sitename", "id", "lt_lit",
  "ms_lit"
)
.mat <- .data %>% pivot_wider(id_cols = .id_cols, names_from = name, values_from = zscore, )
.cids <- intersect(colnames(.mat), meta$name)
.meta <- meta %>% dplyr::filter(name %in% .cids)

ca <- ComplexHeatmap::columnAnnotation(
  treat = .meta$treat,
  annotation_name_side = "left",
  col = list(
    treat = c(
      untreated = "#1f77b4",
      carboplatin = "#ff7f0e",
      IMT = "#2ca02c",
      carboplatin_IMT = "#d62728"
    )
  )
)

#
hide_zero <- function(x) {
  sapply(x, function(y) ifelse(y == 0, "", as.character(y)))
}

row_annotations <- HeatmapAnnotation(
  lt_lit = .mat$lt_lit %>% hide_zero() %>% anno_text(show_name = T, gp = gpar(fontsize = 7), location = unit(.5, "npc"), just = "centre"),
  ms_lit = .mat$ms_lit %>% hide_zero() %>% anno_text(show_name = T, gp = gpar(fontsize = 7), location = unit(.5, "npc"), just = "center"),
  which = "row",
  gp = gpar(fontsize = 2, size = 2),
  width = unit(.3, "in"),
  annotation_name_side = "top",
  border = T,
  show_annotation_name = T
)

.ht_mat <- .mat[, .meta$name] %>% as.matrix()
ht <- ComplexHeatmap::Heatmap(
  .ht_mat,
  column_split = .meta$treat,
  row_labels = .mat$sitename,
  row_names_gp = grid::gpar(fontsize = 7),
  column_names_side = "top",
  heatmap_legend_param = list(title = "zscore"),
  column_title = .y,
  right_annotation = row_annotations,
  top_annotation = ca,
  cluster_rows = dendsort(hclust(dist(.ht_mat), method = "ward.D2")),
  # cluster_columns = dendsort(hclust(dist(t(.ht_mat)), method="ward.D2"))
  clustering_method_columns = "ward.D2"
  # clustering_method_rows = "ward.D2",
  # clustering_method_columns = "ward.D2"
)

.outdir <- file.path("../", "results", "modi")
.outf <- "stat1"
.fulloutf <- file.path(.outdir, paste0(make.names(.outf), ".pdf"))
draw(ht)

pdf(.fulloutf, height = 7, width = 13)
print(ht)
dev.off()
```

